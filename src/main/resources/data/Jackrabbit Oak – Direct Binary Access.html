<!DOCTYPE html>


<!--
 | Generated by Apache Maven Doxia Site Renderer 1.11.1 from src/site/markdown/features/direct-binary-access.md at 2024-06-11
 | Rendered using Apache Maven Fluido Skin 1.11.1
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.11.1" />
    <title>Jackrabbit Oak &#x2013; Direct Binary Access</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.11.1.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
    <script src="../js/apache-maven-fluido-1.11.1.min.js"></script>

    <!-- Matomo -->
    <script>
        var _paq = window._paq = window._paq || [];
                _paq.push(['disableCookies']);
                    _paq.push(['trackPageView']);
                    _paq.push(['enableLinkTracking']);
        
        (function() {
            var u="https://analytics.apache.org";
            _paq.push(['setTrackerUrl', u+'/matomo.php']);
            _paq.push(['setSiteId', '4']);
            var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
            g.async=true; g.src=u+'/matomo.js'; s.parentNode.insertBefore(g,s);
        })();
    </script>
    <!-- End Matomo Code -->
  </head>
  <body class="topBarEnabled">
    <a class="github-fork-ribbon right-top" href="https://github.com/apache/jackrabbit-oak" data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a>
    <header id="topbar" class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
        <div class="container-fluid">
        <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
<a class="brand" href="../"  title="Oak logo"><img src="../oak_logo.png" alt="Oak logo" />
</a>
            <ul class="nav">
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown">Overview <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../index.html" title="Jackrabbit Oak">Jackrabbit Oak</a></li>
            <li><a href="../license.html" title="License">License</a></li>
            <li><a href="../downloads.html" title="Downloads">Downloads</a></li>
            <li><a href="../roadmap.html" title="Roadmap">Roadmap</a></li>
            <li><a href="../articles.html" title="Articles">Articles</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown">Concepts and Architecture <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../architecture/overview.html" title="Overview">Overview</a></li>
            <li><a href="../architecture/nodestate.html" title="The Node State Model">The Node State Model</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown">Main APIs <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="https://s.apache.org/jcr-2.0-spec/index.html" title="JCR API">JCR API</a></li>
            <li><a href="https://jackrabbit.apache.org/jcr/jcr-api.html" title="Jackrabbit API">Jackrabbit API</a></li>
            <li><a href="../oak_api/overview.html" title="Oak API">Oak API</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown">Features and Plugins <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li class="dropdown-submenu">
<a href="../nodestore/overview.html" title="Node Storage">Node Storage</a>
              <ul class="dropdown-menu">
                  <li><a href="../nodestore/documentmk.html" title="Document NodeStore">Document NodeStore</a></li>
                  <li><a href="../nodestore/segment/overview.html" title="Segment NodeStore">Segment NodeStore</a></li>
                  <li><a href="../nodestore/compositens.html" title="Composite NodeStore">Composite NodeStore</a></li>
              </ul>
            </li>
            <li class="dropdown-submenu">
<a href="../plugins/blobstore.html" title="Blob Storage">Blob Storage</a>
              <ul class="dropdown-menu">
                  <li><a title="Direct Binary Access">Direct Binary Access</a></li>
                  <li><a href="../features/direct-binary-access-upload-file.html" title="Direct Binary Access Upload File">Direct Binary Access Upload File</a></li>
              </ul>
            </li>
            <li class="dropdown-submenu">
<a href="../query/query.html" title="Query">Query</a>
              <ul class="dropdown-menu">
                  <li><a href="../query/query-engine.html" title="Query Engine">Query Engine</a></li>
                  <li><a href="../query/grammar-xpath.html" title="XPath Grammar">XPath Grammar</a></li>
                  <li><a href="../query/grammar-sql2.html" title="SQL-2 Grammar">SQL-2 Grammar</a></li>
                  <li><a href="../query/query-troubleshooting.html" title="Troubleshooting">Troubleshooting</a></li>
                  <li><a href="../query/indexing.html" title="Indexing">Indexing</a></li>
                  <li><a href="../query/oak-run-indexing.html" title="Indexing with Oak-Run">Indexing with Oak-Run</a></li>
                  <li><a href="../query/lucene.html" title="Lucene Index">Lucene Index</a></li>
                  <li><a href="../query/elastic.html" title="Elastic Index">Elastic Index</a></li>
                  <li><a href="../query/property-index.html" title="Property Index">Property Index</a></li>
                  <li><a href="../query/hybrid-index.html" title="Hybrid Index">Hybrid Index</a></li>
                  <li><a href="../query/solr.html" title="Solr Index">Solr Index</a></li>
              </ul>
            </li>
            <li class="dropdown-submenu">
<a href="../security/overview.html" title="Security">Security</a>
              <ul class="dropdown-menu">
                  <li><a href="../security/introduction.html" title="Introduction">Introduction</a></li>
                  <li><a href="../security/reports.html" title="Reports">Reports</a></li>
                  <li><a href="../security/authentication.html" title="Authentication">Authentication</a></li>
                  <li><a href="../security/authorization.html" title="Authorization">Authorization</a></li>
                  <li><a href="../security/principal.html" title="Principal Management">Principal Management</a></li>
                  <li><a href="../security/user.html" title="User Management">User Management</a></li>
              </ul>
            </li>
            <li><a href="../features/atomic-counter.html" title="Atomic Counter">Atomic Counter</a></li>
            <li><a href="../features/observation.html" title="Observation">Observation</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown">Using Oak <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../use_getting_started.html" title="Getting Started">Getting Started</a></li>
            <li><a href="../construct.html" title="Repository Construction">Repository Construction</a></li>
            <li><a href="../osgi_config.html" title="Configuring Oak">Configuring Oak</a></li>
            <li><a href="../command_line.html" title="Command Line Tools">Command Line Tools</a></li>
            <li><a href="../migration.html" title="Migration">Migration</a></li>
            <li><a href="../differences.html" title="Differences to Jackrabbit 2">Differences to Jackrabbit 2</a></li>
            <li><a href="../known_issues.html" title="Known Issues">Known Issues</a></li>
            <li><a href="../constraints.html" title="Constraints">Constraints</a></li>
            <li><a href="../dos_and_donts.html" title="Dos and Don'ts">Dos and Don'ts</a></li>
            <li><a href="../coldstandby/coldstandby.html" title="Cold Standby">Cold Standby</a></li>
            <li><a href="../FAQ.html" title="FAQ">FAQ</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown">Developing Oak <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../dev_getting_started.html" title="Getting Started">Getting Started</a></li>
            <li><a href="../participating.html" title="Participating">Participating</a></li>
            <li><a href="../testing.html" title="Testing">Testing</a></li>
            <li><a href="../oakathons.html" title="Oakathons">Oakathons</a></li>
            <li><a href="../developing-with-git.html" title="Developing with Git">Developing with Git</a></li>
            <li><a href="../diagnostic-builds.html" title="Cutting diagnostic builds">Cutting diagnostic builds</a></li>
            <li><a href="../branching.html" title="Branching off a new stable">Branching off a new stable</a></li>
            <li><a href="../attribution.html" title="Attribution">Attribution</a></li>
            <li><a href="../release-schedule.html" title="Release Schedule">Release Schedule</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown">Links <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="http://jackrabbit.apache.org/oak" title="Apache Jackrabbit Oak">Apache Jackrabbit Oak</a></li>
            <li><a href="http://jackrabbit.apache.org/" title="Apache Jackrabbit">Apache Jackrabbit</a></li>
        </ul>
      </li>
            </ul>
        </div>
      </div>
    </header>
    <div class="container-fluid">
      <header>
        <div id="banner">
          <div class="pull-left"><div id="bannerLeft"><h1>Oak Documentation</h1>
</div>
</div>
          <div class="pull-right"></div>
          <div class="clear"><hr/></div>
        </div>

        <div id="breadcrumbs">
          <ul class="breadcrumb">
      <li class=""><a href="https://jackrabbit.apache.org/" class="externalLink" title="Jackrabbit">Jackrabbit</a><span class="divider">/</span></li>
      <li class=""><a href="https://jackrabbit.apache.org/oak/docs/" class="externalLink" title="Oak">Oak</a><span class="divider">/</span></li>
    <li class="active ">Direct Binary Access <a href="https://github.com/apache/jackrabbit-oak/edit/trunk/oak-doc/src/site/markdown/features/direct-binary-access.md"><img src="../images/accessories-text-editor.png" title="Edit" /></a></li>
        <li id="publishDate" class="pull-right">Last Published: 2024-06-11</li>
          </ul>
        </div>
      </header>
      <div class="row-fluid">
        <header id="leftColumn" class="span2">
          <nav class="well sidebar-nav">
  <ul class="nav nav-list">
   <li class="nav-header">Overview</li>
    <li><a href="../index.html" title="Jackrabbit Oak"><span class="none"></span>Jackrabbit Oak</a></li>
    <li><a href="../license.html" title="License"><span class="none"></span>License</a></li>
    <li><a href="../downloads.html" title="Downloads"><span class="none"></span>Downloads</a></li>
    <li><a href="../roadmap.html" title="Roadmap"><span class="none"></span>Roadmap</a></li>
    <li><a href="../articles.html" title="Articles"><span class="none"></span>Articles</a></li>
   <li class="nav-header">Concepts and Architecture</li>
    <li><a href="../architecture/overview.html" title="Overview"><span class="none"></span>Overview</a></li>
    <li><a href="../architecture/nodestate.html" title="The Node State Model"><span class="none"></span>The Node State Model</a></li>
   <li class="nav-header">Main APIs</li>
    <li><a href="https://s.apache.org/jcr-2.0-spec/index.html" class="externalLink" title="JCR API"><span class="none"></span>JCR API</a></li>
    <li><a href="https://jackrabbit.apache.org/jcr/jcr-api.html" class="externalLink" title="Jackrabbit API"><span class="none"></span>Jackrabbit API</a></li>
    <li><a href="../oak_api/overview.html" title="Oak API"><span class="none"></span>Oak API</a></li>
   <li class="nav-header">Features and Plugins</li>
    <li><a href="../nodestore/overview.html" title="Node Storage"><span class="icon-chevron-down"></span>Node Storage</a>
     <ul class="nav nav-list">
      <li><a href="../nodestore/documentmk.html" title="Document NodeStore"><span class="icon-chevron-down"></span>Document NodeStore</a>
       <ul class="nav nav-list">
        <li><a href="../nodestore/document/mongo-document-store.html" title="MongoDB DocumentStore"><span class="none"></span>MongoDB DocumentStore</a></li>
        <li><a href="../nodestore/document/rdb-document-store.html" title="RDB DocumentStore"><span class="none"></span>RDB DocumentStore</a></li>
        <li><a href="../nodestore/document/node-bundling.html" title="Node Bundling"><span class="none"></span>Node Bundling</a></li>
        <li><a href="../nodestore/document/secondary-store.html" title="Secondary Store"><span class="none"></span>Secondary Store</a></li>
        <li><a href="../nodestore/persistent-cache.html" title="Persistent Cache"><span class="none"></span>Persistent Cache</a></li>
        <li><a href="../clustering.html" title="Clustering"><span class="none"></span>Clustering</a></li>
       </ul></li>
      <li><a href="../nodestore/segment/overview.html" title="Segment NodeStore"><span class="none"></span>Segment NodeStore</a></li>
      <li><a href="../nodestore/compositens.html" title="Composite NodeStore"><span class="none"></span>Composite NodeStore</a></li>
     </ul></li>
    <li><a href="../plugins/blobstore.html" title="Blob Storage"><span class="icon-chevron-down"></span>Blob Storage</a>
     <ul class="nav nav-list">
      <li class="active"><a><span class="none"></span>Direct Binary Access</a></li>
      <li><a href="../features/direct-binary-access-upload-file.html" title="Direct Binary Access Upload File"><span class="none"></span>Direct Binary Access Upload File</a></li>
     </ul></li>
    <li><a href="../query/query.html" title="Query"><span class="icon-chevron-down"></span>Query</a>
     <ul class="nav nav-list">
      <li><a href="../query/query-engine.html" title="Query Engine"><span class="none"></span>Query Engine</a></li>
      <li><a href="../query/grammar-xpath.html" title="XPath Grammar"><span class="none"></span>XPath Grammar</a></li>
      <li><a href="../query/grammar-sql2.html" title="SQL-2 Grammar"><span class="none"></span>SQL-2 Grammar</a></li>
      <li><a href="../query/query-troubleshooting.html" title="Troubleshooting"><span class="none"></span>Troubleshooting</a></li>
      <li><a href="../query/indexing.html" title="Indexing"><span class="none"></span>Indexing</a></li>
      <li><a href="../query/oak-run-indexing.html" title="Indexing with Oak-Run"><span class="none"></span>Indexing with Oak-Run</a></li>
      <li><a href="../query/lucene.html" title="Lucene Index"><span class="none"></span>Lucene Index</a></li>
      <li><a href="../query/elastic.html" title="Elastic Index"><span class="none"></span>Elastic Index</a></li>
      <li><a href="../query/property-index.html" title="Property Index"><span class="none"></span>Property Index</a></li>
      <li><a href="../query/hybrid-index.html" title="Hybrid Index"><span class="none"></span>Hybrid Index</a></li>
      <li><a href="../query/solr.html" title="Solr Index"><span class="none"></span>Solr Index</a></li>
     </ul></li>
    <li><a href="../security/overview.html" title="Security"><span class="icon-chevron-down"></span>Security</a>
     <ul class="nav nav-list">
      <li><a href="../security/introduction.html" title="Introduction"><span class="none"></span>Introduction</a></li>
      <li><a href="../security/reports.html" title="Reports"><span class="none"></span>Reports</a></li>
      <li><a href="../security/authentication.html" title="Authentication"><span class="icon-chevron-right"></span>Authentication</a></li>
      <li><a href="../security/authorization.html" title="Authorization"><span class="icon-chevron-right"></span>Authorization</a></li>
      <li><a href="../security/principal.html" title="Principal Management"><span class="icon-chevron-right"></span>Principal Management</a></li>
      <li><a href="../security/user.html" title="User Management"><span class="icon-chevron-right"></span>User Management</a></li>
     </ul></li>
    <li><a href="../features/atomic-counter.html" title="Atomic Counter"><span class="none"></span>Atomic Counter</a></li>
    <li><a href="../features/observation.html" title="Observation"><span class="none"></span>Observation</a></li>
   <li class="nav-header">Using Oak</li>
    <li><a href="../use_getting_started.html" title="Getting Started"><span class="none"></span>Getting Started</a></li>
    <li><a href="../construct.html" title="Repository Construction"><span class="none"></span>Repository Construction</a></li>
    <li><a href="../osgi_config.html" title="Configuring Oak"><span class="none"></span>Configuring Oak</a></li>
    <li><a href="../command_line.html" title="Command Line Tools"><span class="none"></span>Command Line Tools</a></li>
    <li><a href="../migration.html" title="Migration"><span class="none"></span>Migration</a></li>
    <li><a href="../differences.html" title="Differences to Jackrabbit 2"><span class="none"></span>Differences to Jackrabbit 2</a></li>
    <li><a href="../known_issues.html" title="Known Issues"><span class="none"></span>Known Issues</a></li>
    <li><a href="../constraints.html" title="Constraints"><span class="none"></span>Constraints</a></li>
    <li><a href="../dos_and_donts.html" title="Dos and Don'ts"><span class="none"></span>Dos and Don'ts</a></li>
    <li><a href="../coldstandby/coldstandby.html" title="Cold Standby"><span class="none"></span>Cold Standby</a></li>
    <li><a href="../FAQ.html" title="FAQ"><span class="none"></span>FAQ</a></li>
   <li class="nav-header">Developing Oak</li>
    <li><a href="../dev_getting_started.html" title="Getting Started"><span class="none"></span>Getting Started</a></li>
    <li><a href="../participating.html" title="Participating"><span class="none"></span>Participating</a></li>
    <li><a href="../testing.html" title="Testing"><span class="none"></span>Testing</a></li>
    <li><a href="../oakathons.html" title="Oakathons"><span class="none"></span>Oakathons</a></li>
    <li><a href="../developing-with-git.html" title="Developing with Git"><span class="none"></span>Developing with Git</a></li>
    <li><a href="../diagnostic-builds.html" title="Cutting diagnostic builds"><span class="none"></span>Cutting diagnostic builds</a></li>
    <li><a href="../branching.html" title="Branching off a new stable"><span class="none"></span>Branching off a new stable</a></li>
    <li><a href="../attribution.html" title="Attribution"><span class="none"></span>Attribution</a></li>
    <li><a href="../release-schedule.html" title="Release Schedule"><span class="none"></span>Release Schedule</a></li>
   <li class="nav-header">Links</li>
    <li><a href="http://jackrabbit.apache.org/oak" class="externalLink" title="Apache Jackrabbit Oak"><span class="none"></span>Apache Jackrabbit Oak</a></li>
    <li><a href="http://jackrabbit.apache.org/" class="externalLink" title="Apache Jackrabbit"><span class="none"></span>Apache Jackrabbit</a></li>
  </ul>
          </nav>
          <div class="well sidebar-nav">
<form id="search-form" action="https://www.google.com/search" method="get" >
  <input value="jackrabbit.apache.org/oak/docs/" name="sitesearch" type="hidden"/>
  <input class="search-query" name="q" id="query" type="text" placeholder="Search with Google..." />
</form>
            <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </header>
        <main id="bodyColumn"  class="span10" >
<!--
   Licensed to the Apache Software Foundation (ASF) under one or more
   contributor license agreements.  See the NOTICE file distributed with
   this work for additional information regarding copyright ownership.
   The ASF licenses this file to You under the Apache License, Version 2.0
   (the "License"); you may not use this file except in compliance with
   the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
  -->
<h1>Direct Binary Access</h1>
<p><code>@since Oak 1.10</code></p>
<p>This feature enables a remote client of an Oak-based application to upload or download binaries directly to/from a supported Oak <a href="../plugins/blobstore.html">BlobStore</a>, without streaming the binaries through the application and Oak itself.  To use the feature, the underlying storage provider must support this capability and the corresponding Oak BlobStore must implement feature support.  Currently, the feature is implemented in <a class="externalLink" href="https://jackrabbit.apache.org/oak/docs/apidocs/org/apache/jackrabbit/oak/blob/cloud/s3/S3DataStore.html">S3DataStore</a> (over <a class="externalLink" href="https://aws.amazon.com/s3/">Amazon S3</a>) and <a class="externalLink" href="https://jackrabbit.apache.org/oak/docs/apidocs/org/apache/jackrabbit/oak/blob/cloud/azure/blobstorage/AzureDataStore.html">AzureDataStore</a> (over <a class="externalLink" href="https://azure.microsoft.com/en-us/services/storage/blobs/">Microsoft Azure Blob Storage</a>). Authentication and access control is fully enforced by Oak, as the direct access is resource- and time-limited.</p>
<p>Using this feature frees an Oak-based web application from the network, memory and disk I/O involved in transferring binary files, and provides clients of the application with scalable, redundant and high-bandwidth access directly to the cloud storage. This eliminates the web application server and its deployment environment as a potential bottleneck of network capacity. Furthermore, it allows leveraging CDN or transfer acceleration options of the cloud storage providers.</p>
<p>The API is designed to be independent of the particular cloud provider, and relies on standard HTTP binary upload &amp; download, as well as cryptographically signed URLs.</p><section>
<h2><a name="Architecture"></a>Architecture</h2>
<p>The following diagram shows the 3 involved parties:  A <i>remote client</i>, the Oak-based <i>server application</i> and the <i>cloud binary storage</i>. Rather than pushing binaries from the client through the server application and Oak into the cloud binary storage and having the application handle the substantial extra I/O load, we let the client directly stream the binaries in the cloud storage.</p>
<p><img src="direct-binary-access-block-diagram.png" alt="" /></p>
<p>Further background of the design of this feature can be found <a class="externalLink" href="https://jackrabbit.apache.org/archive/wiki/JCR/Direct-Binary-Access_115513390.html">on the wiki</a>.</p></section><section>
<h2><a name="Requirements"></a>Requirements</h2>
<p>To use this feature, Oak must be configured with a <a href="../plugins/blobstore.html">BlobStore</a> that supports this feature.</p>
<p>Currently these Blob/DataStores are supported:</p>
<ul>

<li><a href="../osgi_config.html#Jackrabbit_2_-_S3DataStore">S3DataStore</a></li>
<li>AzureDataStore</li>
</ul>
<p>Please note that <code>Direct Binary Access</code> doesn't work with Customer provided keys. For more info, please refer to AWS documentation on <a class="externalLink" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/ServerSideEncryptionCustomerKeys.html#ssec-and-presignedurl">SSE-C keys</a></p></section><section>
<h2><a name="Configuration"></a>Configuration</h2>
<p>The feature has to be explicitly enabled by setting properties on the DataStore. In the table, &#x201c;S3&#x201d; refers to <code>S3DataStore</code>, &#x201c;Azure&#x201d; to <code>AzureDataStore</code>.</p>
<table border="0" class="table table-striped">
<thead>

<tr class="a">
<th>Property</th>
<th>Type</th>
<th>Default</th>
<th>Description</th></tr>
</thead><tbody>

<tr class="b">
<td align="left"><code>presignedHttpUploadURIExpirySeconds</code></td>
<td>Integer</td>
<td>0 (disabled)</td>
<td>Time limit for upload URLs, in seconds. Choose a value long enough for clients to upload larger binaries and possibly retry, but not unlimited to ensure access control. Setting to 0 disables the direct upload feature.</td></tr>
<tr class="a">
<td align="left"><code>presignedHttpDownloadURIExpirySeconds</code></td>
<td>Integer</td>
<td>0 (disabled)</td>
<td>Time limit for download URLs, in seconds. Choose a value long enough for clients to download larger binaries and possibly retry, but not unlimited to ensure access control. Setting to 0 disables the direct download feature.</td></tr>
<tr class="b">
<td align="left"><code>presignedHttpDownloadURICacheMaxSize</code></td>
<td>Integer</td>
<td>0 (disabled)</td>
<td><b>Experimental.</b> Cache size for reusing download URLs. Expired URLs will be cached for half their expiry time, hence if this feature is enabled, clients might get URLs that expire after half of <code>presignedHttpDownloadURIExpirySeconds</code>. Setting to 0 disables the cache.</td></tr>
<tr class="a">
<td align="left"><code>presignedHttpDownloadURIVerifyExists</code></td>
<td>Boolean</td>
<td>true</td>
<td>Flag to determine whether to check that a binary exists in blob storage before issuing a presigned download URI.  The default is to verify existence first, providing assurance that the signed URI references an existing binary.  If this flag is set to false, the existence check is skipped.  This makes generating the signed URI anywhere from 100 to 1000 times faster since no network API calls are made, but means it is possible in some cases to return a signed URI that doesn't reference an existing blob.  See <a class="externalLink" href="https://issues.apache.org/jira/browse/OAK-7998">OAK-7998</a> and <a class="externalLink" href="https://issues.apache.org/jira/browse/OAK-8552">OAK-8552</a> for more details.</td></tr>
<tr class="b">
<td align="left">S3:&#xa0;<code>presignedURIEnableTransferAcceleration</code> <br />Azure:&#xa0;n/a</td>
<td>Boolean</td>
<td>false (disabled)</td>
<td><b>Experimental.</b> Enables <a class="externalLink" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/transfer-acceleration.html">S3 Transfer Acceleration</a> for both upload and download URLs. Transfer acceleration must be enabled on the S3 bucket before Oak starts.</td></tr>
</tbody>
</table></section><section>
<h2><a name="API_Javadoc"></a>API Javadoc</h2>
<p>The APIs for this feature are available in <a class="externalLink" href="https://jackrabbit.apache.org/jcr/jcr-api.html">jackrabbit-api</a>:</p>
<ul>

<li><a class="externalLink" href="http://jackrabbit.apache.org/oak/docs/apidocs/org/apache/jackrabbit/api/JackrabbitValueFactory.html">JackrabbitValueFactory</a> for uploading - cast <code>session.getValueFactory()</code> to this and use <code>initiateBinaryUpload()</code> and <code>completeBinaryUpload()</code></li>
<li><a class="externalLink" href="http://jackrabbit.apache.org/oak/docs/apidocs/org/apache/jackrabbit/api/binary/BinaryDownload.html">BinaryDownload</a> for downloading - cast a <code>Binary</code> to this and call <code>getURI()</code></li>
<li>other elements are in the <a class="externalLink" href="http://jackrabbit.apache.org/oak/docs/apidocs/org/apache/jackrabbit/api/binary/package-summary.html">org.apache.jackrabbit.api.binary package</a></li>
</ul></section><section>
<h2><a name="Usage"></a>Usage</h2><section>
<h3><a name="Download"></a>Download</h3>
<p><img src="direct-binary-download-block-diagram.png" alt="" /></p>
<p>This example shows how to retrieve a time-limited presigned URL for reading a binary:</p>

<div class="source"><pre class="prettyprint"><code>Node ntFile = session.getNode(&quot;/content/file.png&quot;);
Node ntResource = ntFile.getNode(&quot;jcr:content&quot;);

Binary binary = ntResource.getProperty(&quot;jcr:data&quot;).getBinary();

if (binary instanceof BinaryDownload) {
    BinaryDownload binaryDownload = (BinaryDownload) binary;

    BinaryDownloadOptions.BinaryDownloadOptionsBuilder builder = BinaryDownloadOptions.builder()
        // would typically come from a JCR node name
        .withFileName(ntFile.getName())
        // mime type must typically be set and would be stored along with the nt:file
        .withMediaType(ntResource.getProperty(&quot;jcr:mimeType&quot;));

    if (ntResource.hasProperty(&quot;jcr:encoding&quot;)) {
        builder.withCharacterEncoding(ntResource.getProperty(&quot;jcr:encoding&quot;));
    }

    // if you need to prevent the browser from potentially executing the response
    // (for example js, flash, html), you can enforce a download with this option
    // builder.withDispositionTypeAttachment();

    URI uri = binaryDownload.getURI(builder.build());

    if (uri == null) {
        // feature not available
        // ...
    }

    // use uri in &lt;img src=&quot;uri&quot;&gt; or send in response to remote client
    // ...
}
</code></pre></div>
<p>Please note that only <code>Binary</code> objects returned from <code>Property.getBinary()</code>, <code>Property.getValue().getBinary()</code> or <code>Property.getValues() ... getBinary()</code> will support a functional <code>BinaryDownload</code>.</p>
<p>Also note that clients should always check whether the URI returned from the <code>getURI()</code> call is null.  A null return value generally indicates that the feature is not available.  But this situation is also possible in two other cases:</p>
<ul>

<li>If the binary is stored in-line in the node store.  If the binary is smaller than the minimum upload size, it will be stored in the node store instead of in cloud blob storage, and thus a direct download URI cannot be provided.</li>
<li>If the data store implementation is using asynchronous uploads and the binary is still in cache.  If a client adds a binary via the repository (i.e. not using the direct binary upload feature) and then immediately requests a download URI for it, it is possible that the binary is still in cache and not yet uploaded to cloud storage, and thus a direct download URI cannot be provided.</li>
</ul></section><section>
<h3><a name="Upload"></a>Upload</h3>
<p>The direct binary upload process is split into 3 phases:</p>
<ol style="list-style-type: decimal">

<li><b>Initialize:</b> A remote client makes request to the Jackrabbit-based application to request an upload, which calls <code>initiateBinaryUpload(long, int)</code> and returns the resulting information to the remote client.</li>
<li><b>Upload:</b> The remote client performs the actual binary upload directly to the binary storage provider. The <code>BinaryUpload</code> returned from the previous call to <code>initiateBinaryUpload(long, int)</code> contains a list of URIs that can be used to upload.  Clients use these URIs to upload; however, it is not required for clients to use all the URIs in the list.  The number of URIs that must be used is subject to the size of the binary being uploaded and the minimum and maximum sizes returned in the <code>BinaryUpload</code> object, which constitutes detailed instructions on how to complete the upload successfully. For more information, including details on the upload algorithm, see the <a class="externalLink" href="https://jackrabbit.apache.org/oak/docs/apidocs/org/apache/jackrabbit/api/binary/BinaryUpload.html"><code>BinaryUpload</code> documentation</a>.</li>
<li><b>Complete:</b> The remote client notifies the Jackrabbit-based application that step 2 is complete. The upload token returned in the first step (obtained by calling <code>BinaryUpload.getUploadToken()</code>) is passed by the client to <code>completeBinaryUpload(String)</code>. This will provide the application with a regular JCR Binary that can then be used to write JCR content including the binary (such as an <code>nt:file</code> structure) and persist it.</li>
</ol>
<p><img src="direct-binary-upload-block-diagram.png" alt="" /></p><section>
<h4><a name="a1._Initiate"></a>1. Initiate</h4>
<p>A remote client would make a request to an HTTP API and provide the file size of the file to upload and the JCR path to upload it to:</p>
<p><code>POST /initiate-upload?filesize=1234&amp;path=/content/file.png</code></p>
<p>The code example below shows this servlet using the API and returning the upload instructions to the client.</p>

<div class="source"><pre class="prettyprint"><code>/**
 * Servlet registered under /initiate-upload
 */
public class InitiateUploadServlet extends HttpServlet {

   public void doPost(HttpServletRequest request, HttpServletResponse response)
               throws IOException, ServletException {

        final Session session = // .. retrieve session for request

        // allows to limit number of returned URIs in case the response message size is limited
        // use -1 for unlimited
        final int maxURIs = 50;

        final String path = request.getParameter(&quot;path&quot;);
        final long filesize = Long.parseLong(request.getParameter(&quot;filesize&quot;));

        ValueFactory vf = session.getValueFactory();
        if (vf instanceof JackrabbitValueFactory) {
            JackrabbitValueFactory valueFactory = (JackrabbitValueFactory) vf;

            BinaryUpload upload = valueFactory.initiateBinaryUpload(filesize, maxURIs);

            if (upload == null) {
                // feature not available, must pass binary via InputStream through vf.createBinary()
                // ...
            } else {
                JSONObject json = new JSONObject();
                json.put(&quot;minPartSize&quot;, upload.getMinPartSize());
                json.put(&quot;maxPartSize&quot;, upload.getMaxPartSize());

                JSONArray uris = new JSONArray();
                Iterator&lt;URI&gt; iter = upload.getUploadURIs();
                while (iter.hasNext()) {
                    uris.put(iter.next());
                }
                json.put(&quot;uploadURIs&quot;, uris);

                // provide the client with a complete URL to request later, pass through the path
                json.put(&quot;completeURL&quot;, &quot;/complete-upload?uploadToken=&quot; + upload.getUploadToken() + &quot;&amp;path=&quot; + path);

                response.setContentType(&quot;application/json&quot;);
                response.setCharacterEncoding(&quot;UTF-8&quot;);
                response.getWriter().write(json.toString());
            }
        } else {
            // feature not available, must pass binary via InputStream through vf.createBinary()
            // ...
        }
    }
}
</code></pre></div>
<p>Clients should always check whether the <code>BinaryUpload</code> returned from <code>valueFactory.initiateBinaryUpload()</code> is null.  This situation indicates that the feature is not supported.</p></section><section>
<h4><a name="a2._Upload"></a>2. Upload</h4>
<p>The remote client will upload using the instructions according to the <a class="externalLink" href="http://jackrabbit.apache.org/oak/docs/apidocs/org/apache/jackrabbit/api/binary/BinaryUpload.html">upload algorithm described in BinaryUpload</a>.</p></section><section>
<h4><a name="a3._Complete"></a>3. Complete</h4>
<p>After the upload has successfully completed, it will notify the application, in this case by making a request to the <code>completeURL</code> from the response:</p>
<p><code>POST /complete-upload?uploadToken=abcdedfghijkl</code></p>
<p>The code example below shows the servlet to handle the <code>complete-upload</code> request:</p>

<div class="source"><pre class="prettyprint"><code>/**
 * Servlet registered under /complete-upload
 */
public class CompleteUploadServlet extends HttpServlet {

   public void doPost(HttpServletRequest request, HttpServletResponse response)
               throws IOException, ServletException {

        final Session session = // .. retrieve session for request

        final String path = request.getParameter(&quot;path&quot;);
        final String uploadToken = request.getParameter(&quot;uploadToken&quot;);

        ValueFactory vf = session.getValueFactory();
        if (vf instanceof JackrabbitValueFactory) {
            JackrabbitValueFactory valueFactory = (JackrabbitValueFactory) vf;

            Binary binary = valueFactory.completeBinaryUpload(uploadToken);

            Node ntFile = JcrUtils.getOrCreateByPath(path, &quot;nt:file&quot;, session);
            Node ntResource = ntFile.addNode(&quot;jcr:content&quot;, &quot;nt:resource&quot;);

            ntResource.setProperty(&quot;jcr:data&quot;, binary);

            // also set jcr:mimeType etc.

            session.save();

        } else {
            // feature not available - not unexpected if initiate-upload worked
        }
    }
}
</code></pre></div>
<h1>CDN Support</h1>
<p><code>@since Oak 1.18 (AzureDataStore)</code></p>
<p>Oak can be configured to make use of CDNs if desired.  Configuring a CDN for use with Oak can provide clients with accelerated blob access times as blobs are accessed via more local caches instead of from the origin blob store.</p></section></section></section><section>
<h2><a name="Preconditions"></a>Preconditions</h2>
<p>The following conditions must be true to leverage a CDN:</p>
<ul>

<li>You must be using <code>AzureDataStore</code>.  (<code>S3DataStore</code> will be supported at a future date but is not currently supported.)</li>
<li>You must have Direct Binary Access enabled - CDNs only offer a benefit with direct access URIs.</li>
<li>You must have a CDN configured that uses your cloud blob storage container as the origin.</li>
</ul></section><section>
<h2><a name="Configuration"></a>Configuration</h2>
<p>Add one or both of the following configuration options to the data store configuration file:</p>
<table border="0" class="table table-striped">
<thead>

<tr class="a">
<th>Property</th>
<th>Type</th>
<th>Default</th>
<th>Description</th></tr>
</thead><tbody>

<tr class="b">
<td align="left"><code>presignedHttpDownloadURIDomainOverride</code></td>
<td>String</td>
<td>null</td>
<td>When this property is set, the domain provided will be used for direct download URIs instead of the default direct download domain.</td></tr>
<tr class="a">
<td align="left"><code>presignedHttpUploadURIDomainOverride</code></td>
<td>String</td>
<td>null</td>
<td>When this property is set, the domain provided will be used for direct upload URIs instead of the default direct upload domain.</td></tr>
</tbody>
</table>
<p>When set, the property value should be a valid fully-qualified domain name, e.g. &#x201c;mycdndomain.azureedge.net&#x201d;.</p></section><section>
<h2><a name="Uses"></a>Uses</h2>
<p>CDNs may be used for direct upload as well as direct download, if the CDN in question supports such behavior.  CDNs that support this behavior include AWS CloudFront, all Azure CDN offerings, and some other third-party CDNs do as well; however, these capabilities are the responsibility of the service providers, not Oak.  Check with your CDN provider for authoritative information on suitability; comprehensive testing is recommended.</p>
<p>Note that you are not required to configure both domains, nor is it required that both domains be the same.  For example, if one CDN offers the best download performance and another CDN offers the best upload performance, you may choose to implement both and set each configuration parameter to a different domain.  Likewise, you are not required to set them both.  If you only wish to use CDNs for download but not upload, simply configure the download parameter with the CDN domain and don't configure an upload domain.</p></section><section>
<h2><a name="Ignoring_the_Domain_Override"></a>Ignoring the Domain Override</h2>
<p><code>@since Oak 1.22 (AzureDataStore)</code></p>
<p>Usually if a domain override is configured, this value should be used for all signed URI requests because using this domain should result in a better experience.  However, there can be cases where a client does not want to use the domain override even if it is configured.</p>
<p>For example, suppose you have a service running in the cloud and this service will be issuing requests with signed URIs.  Suppose that this service is running in the same cloud region as your blob storage.  In such a case, it will probably be much faster for the service to resolve the URI request using the default URI domain rather than the CDN domain, because most cloud service providers resolve these DNS names internally and route the traffic much more efficiently.  If the client that asks for the signed URI knows that it will be giving the URI to such a service to download, it may wish to indicate that it wants to ignore any configured domain override for this URI.</p>
<p>To specify this behavior for signed download URIs, the client requesting the URI should specify to ignore the domain override when building the <code>BinaryDownloadOptions</code>:</p>

<div class="source"><pre class="prettyprint"><code>BinaryDownloadOptions options = BinaryDownloadOptions.builder()
    .withDomainOverrideIgnored(true)
    .build();
</code></pre></div>
<p>Default behavior is to use the domain override if one is configured.</p>
<p>To ignore any configured domain override for signed upload URIs, the client requesting the URI should specify to ignore the domain override via the optional <code>BinaryUploadOptions</code> parameter:</p>

<div class="source"><pre class="prettyprint"><code>BinaryUploadOptions options = BinaryUploadOptions.builder()
    .withDomainOverrideIgnored(true)
    .build();
</code></pre></div>
<p>Default behavior is to use the domain override if one is configured.  Note that providing a <code>BinaryUploadOptions</code> to <code>JackrabbitValueFactory.initiateBinaryUpload()</code> is optional, and if not provided the default behavior is used.</p></section>
        </main>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
<p>&#169; 2012-2024
<a href="https://www.apache.org/">The Apache Software Foundation</a> &vert; <a href="https://privacy.apache.org/policies/privacy-policy-public.html">Privacy Policy</a>
</p>
        </div>
      </div>
    </footer>
<script>
	if(anchors) {
	  anchors.add();
	}
</script>
  </body>
</html>