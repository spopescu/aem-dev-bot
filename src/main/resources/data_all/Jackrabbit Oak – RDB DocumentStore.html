<!DOCTYPE html>


<!--
 | Generated by Apache Maven Doxia Site Renderer 1.11.1 from src/site/markdown/nodestore/document/rdb-document-store.md at 2024-06-11
 | Rendered using Apache Maven Fluido Skin 1.11.1
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.11.1" />
    <title>Jackrabbit Oak &#x2013; RDB DocumentStore</title>
    <link rel="stylesheet" href="../../css/apache-maven-fluido-1.11.1.min.css" />
    <link rel="stylesheet" href="../../css/site.css" />
    <link rel="stylesheet" href="../../css/print.css" media="print" />
    <script src="../../js/apache-maven-fluido-1.11.1.min.js"></script>

    <!-- Matomo -->
    <script>
        var _paq = window._paq = window._paq || [];
                _paq.push(['disableCookies']);
                    _paq.push(['trackPageView']);
                    _paq.push(['enableLinkTracking']);
        
        (function() {
            var u="https://analytics.apache.org";
            _paq.push(['setTrackerUrl', u+'/matomo.php']);
            _paq.push(['setSiteId', '4']);
            var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
            g.async=true; g.src=u+'/matomo.js'; s.parentNode.insertBefore(g,s);
        })();
    </script>
    <!-- End Matomo Code -->
  </head>
  <body class="topBarEnabled">
    <a class="github-fork-ribbon right-top" href="https://github.com/apache/jackrabbit-oak" data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a>
    <header id="topbar" class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
        <div class="container-fluid">
        <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
<a class="brand" href="../../"  title="Oak logo"><img src="../../oak_logo.png" alt="Oak logo" />
</a>
            <ul class="nav">
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown">Overview <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../../index.html" title="Jackrabbit Oak">Jackrabbit Oak</a></li>
            <li><a href="../../license.html" title="License">License</a></li>
            <li><a href="../../downloads.html" title="Downloads">Downloads</a></li>
            <li><a href="../../roadmap.html" title="Roadmap">Roadmap</a></li>
            <li><a href="../../articles.html" title="Articles">Articles</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown">Concepts and Architecture <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../../architecture/overview.html" title="Overview">Overview</a></li>
            <li><a href="../../architecture/nodestate.html" title="The Node State Model">The Node State Model</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown">Main APIs <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="https://s.apache.org/jcr-2.0-spec/index.html" title="JCR API">JCR API</a></li>
            <li><a href="https://jackrabbit.apache.org/jcr/jcr-api.html" title="Jackrabbit API">Jackrabbit API</a></li>
            <li><a href="../../oak_api/overview.html" title="Oak API">Oak API</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown">Features and Plugins <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li class="dropdown-submenu">
<a href="../../nodestore/overview.html" title="Node Storage">Node Storage</a>
              <ul class="dropdown-menu">
                  <li><a href="../../nodestore/documentmk.html" title="Document NodeStore">Document NodeStore</a></li>
                  <li><a href="../../nodestore/segment/overview.html" title="Segment NodeStore">Segment NodeStore</a></li>
                  <li><a href="../../nodestore/compositens.html" title="Composite NodeStore">Composite NodeStore</a></li>
              </ul>
            </li>
            <li class="dropdown-submenu">
<a href="../../plugins/blobstore.html" title="Blob Storage">Blob Storage</a>
              <ul class="dropdown-menu">
                  <li><a href="../../features/direct-binary-access.html" title="Direct Binary Access">Direct Binary Access</a></li>
                  <li><a href="../../features/direct-binary-access-upload-file.html" title="Direct Binary Access Upload File">Direct Binary Access Upload File</a></li>
              </ul>
            </li>
            <li class="dropdown-submenu">
<a href="../../query/query.html" title="Query">Query</a>
              <ul class="dropdown-menu">
                  <li><a href="../../query/query-engine.html" title="Query Engine">Query Engine</a></li>
                  <li><a href="../../query/grammar-xpath.html" title="XPath Grammar">XPath Grammar</a></li>
                  <li><a href="../../query/grammar-sql2.html" title="SQL-2 Grammar">SQL-2 Grammar</a></li>
                  <li><a href="../../query/query-troubleshooting.html" title="Troubleshooting">Troubleshooting</a></li>
                  <li><a href="../../query/indexing.html" title="Indexing">Indexing</a></li>
                  <li><a href="../../query/oak-run-indexing.html" title="Indexing with Oak-Run">Indexing with Oak-Run</a></li>
                  <li><a href="../../query/lucene.html" title="Lucene Index">Lucene Index</a></li>
                  <li><a href="../../query/elastic.html" title="Elastic Index">Elastic Index</a></li>
                  <li><a href="../../query/property-index.html" title="Property Index">Property Index</a></li>
                  <li><a href="../../query/hybrid-index.html" title="Hybrid Index">Hybrid Index</a></li>
                  <li><a href="../../query/solr.html" title="Solr Index">Solr Index</a></li>
              </ul>
            </li>
            <li class="dropdown-submenu">
<a href="../../security/overview.html" title="Security">Security</a>
              <ul class="dropdown-menu">
                  <li><a href="../../security/introduction.html" title="Introduction">Introduction</a></li>
                  <li><a href="../../security/reports.html" title="Reports">Reports</a></li>
                  <li><a href="../../security/authentication.html" title="Authentication">Authentication</a></li>
                  <li><a href="../../security/authorization.html" title="Authorization">Authorization</a></li>
                  <li><a href="../../security/principal.html" title="Principal Management">Principal Management</a></li>
                  <li><a href="../../security/user.html" title="User Management">User Management</a></li>
              </ul>
            </li>
            <li><a href="../../features/atomic-counter.html" title="Atomic Counter">Atomic Counter</a></li>
            <li><a href="../../features/observation.html" title="Observation">Observation</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown">Using Oak <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../../use_getting_started.html" title="Getting Started">Getting Started</a></li>
            <li><a href="../../construct.html" title="Repository Construction">Repository Construction</a></li>
            <li><a href="../../osgi_config.html" title="Configuring Oak">Configuring Oak</a></li>
            <li><a href="../../command_line.html" title="Command Line Tools">Command Line Tools</a></li>
            <li><a href="../../migration.html" title="Migration">Migration</a></li>
            <li><a href="../../differences.html" title="Differences to Jackrabbit 2">Differences to Jackrabbit 2</a></li>
            <li><a href="../../known_issues.html" title="Known Issues">Known Issues</a></li>
            <li><a href="../../constraints.html" title="Constraints">Constraints</a></li>
            <li><a href="../../dos_and_donts.html" title="Dos and Don'ts">Dos and Don'ts</a></li>
            <li><a href="../../coldstandby/coldstandby.html" title="Cold Standby">Cold Standby</a></li>
            <li><a href="../../FAQ.html" title="FAQ">FAQ</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown">Developing Oak <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../../dev_getting_started.html" title="Getting Started">Getting Started</a></li>
            <li><a href="../../participating.html" title="Participating">Participating</a></li>
            <li><a href="../../testing.html" title="Testing">Testing</a></li>
            <li><a href="../../oakathons.html" title="Oakathons">Oakathons</a></li>
            <li><a href="../../developing-with-git.html" title="Developing with Git">Developing with Git</a></li>
            <li><a href="../../diagnostic-builds.html" title="Cutting diagnostic builds">Cutting diagnostic builds</a></li>
            <li><a href="../../branching.html" title="Branching off a new stable">Branching off a new stable</a></li>
            <li><a href="../../attribution.html" title="Attribution">Attribution</a></li>
            <li><a href="../../release-schedule.html" title="Release Schedule">Release Schedule</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown">Links <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="http://jackrabbit.apache.org/oak" title="Apache Jackrabbit Oak">Apache Jackrabbit Oak</a></li>
            <li><a href="http://jackrabbit.apache.org/" title="Apache Jackrabbit">Apache Jackrabbit</a></li>
        </ul>
      </li>
            </ul>
        </div>
      </div>
    </header>
    <div class="container-fluid">
      <header>
        <div id="banner">
          <div class="pull-left"><div id="bannerLeft"><h1>Oak Documentation</h1>
</div>
</div>
          <div class="pull-right"></div>
          <div class="clear"><hr/></div>
        </div>

        <div id="breadcrumbs">
          <ul class="breadcrumb">
      <li class=""><a href="https://jackrabbit.apache.org/" class="externalLink" title="Jackrabbit">Jackrabbit</a><span class="divider">/</span></li>
      <li class=""><a href="https://jackrabbit.apache.org/oak/docs/" class="externalLink" title="Oak">Oak</a><span class="divider">/</span></li>
    <li class="active ">RDB DocumentStore <a href="https://github.com/apache/jackrabbit-oak/edit/trunk/oak-doc/src/site/markdown/nodestore/document/rdb-document-store.md"><img src="../../images/accessories-text-editor.png" title="Edit" /></a></li>
        <li id="publishDate" class="pull-right">Last Published: 2024-06-11</li>
          </ul>
        </div>
      </header>
      <div class="row-fluid">
        <header id="leftColumn" class="span2">
          <nav class="well sidebar-nav">
  <ul class="nav nav-list">
   <li class="nav-header">Overview</li>
    <li><a href="../../index.html" title="Jackrabbit Oak"><span class="none"></span>Jackrabbit Oak</a></li>
    <li><a href="../../license.html" title="License"><span class="none"></span>License</a></li>
    <li><a href="../../downloads.html" title="Downloads"><span class="none"></span>Downloads</a></li>
    <li><a href="../../roadmap.html" title="Roadmap"><span class="none"></span>Roadmap</a></li>
    <li><a href="../../articles.html" title="Articles"><span class="none"></span>Articles</a></li>
   <li class="nav-header">Concepts and Architecture</li>
    <li><a href="../../architecture/overview.html" title="Overview"><span class="none"></span>Overview</a></li>
    <li><a href="../../architecture/nodestate.html" title="The Node State Model"><span class="none"></span>The Node State Model</a></li>
   <li class="nav-header">Main APIs</li>
    <li><a href="https://s.apache.org/jcr-2.0-spec/index.html" class="externalLink" title="JCR API"><span class="none"></span>JCR API</a></li>
    <li><a href="https://jackrabbit.apache.org/jcr/jcr-api.html" class="externalLink" title="Jackrabbit API"><span class="none"></span>Jackrabbit API</a></li>
    <li><a href="../../oak_api/overview.html" title="Oak API"><span class="none"></span>Oak API</a></li>
   <li class="nav-header">Features and Plugins</li>
    <li><a href="../../nodestore/overview.html" title="Node Storage"><span class="icon-chevron-down"></span>Node Storage</a>
     <ul class="nav nav-list">
      <li><a href="../../nodestore/documentmk.html" title="Document NodeStore"><span class="icon-chevron-down"></span>Document NodeStore</a>
       <ul class="nav nav-list">
        <li><a href="../../nodestore/document/mongo-document-store.html" title="MongoDB DocumentStore"><span class="none"></span>MongoDB DocumentStore</a></li>
        <li class="active"><a><span class="none"></span>RDB DocumentStore</a></li>
        <li><a href="../../nodestore/document/node-bundling.html" title="Node Bundling"><span class="none"></span>Node Bundling</a></li>
        <li><a href="../../nodestore/document/secondary-store.html" title="Secondary Store"><span class="none"></span>Secondary Store</a></li>
        <li><a href="../../nodestore/persistent-cache.html" title="Persistent Cache"><span class="none"></span>Persistent Cache</a></li>
        <li><a href="../../clustering.html" title="Clustering"><span class="none"></span>Clustering</a></li>
       </ul></li>
      <li><a href="../../nodestore/segment/overview.html" title="Segment NodeStore"><span class="none"></span>Segment NodeStore</a></li>
      <li><a href="../../nodestore/compositens.html" title="Composite NodeStore"><span class="none"></span>Composite NodeStore</a></li>
     </ul></li>
    <li><a href="../../plugins/blobstore.html" title="Blob Storage"><span class="icon-chevron-down"></span>Blob Storage</a>
     <ul class="nav nav-list">
      <li><a href="../../features/direct-binary-access.html" title="Direct Binary Access"><span class="none"></span>Direct Binary Access</a></li>
      <li><a href="../../features/direct-binary-access-upload-file.html" title="Direct Binary Access Upload File"><span class="none"></span>Direct Binary Access Upload File</a></li>
     </ul></li>
    <li><a href="../../query/query.html" title="Query"><span class="icon-chevron-down"></span>Query</a>
     <ul class="nav nav-list">
      <li><a href="../../query/query-engine.html" title="Query Engine"><span class="none"></span>Query Engine</a></li>
      <li><a href="../../query/grammar-xpath.html" title="XPath Grammar"><span class="none"></span>XPath Grammar</a></li>
      <li><a href="../../query/grammar-sql2.html" title="SQL-2 Grammar"><span class="none"></span>SQL-2 Grammar</a></li>
      <li><a href="../../query/query-troubleshooting.html" title="Troubleshooting"><span class="none"></span>Troubleshooting</a></li>
      <li><a href="../../query/indexing.html" title="Indexing"><span class="none"></span>Indexing</a></li>
      <li><a href="../../query/oak-run-indexing.html" title="Indexing with Oak-Run"><span class="none"></span>Indexing with Oak-Run</a></li>
      <li><a href="../../query/lucene.html" title="Lucene Index"><span class="none"></span>Lucene Index</a></li>
      <li><a href="../../query/elastic.html" title="Elastic Index"><span class="none"></span>Elastic Index</a></li>
      <li><a href="../../query/property-index.html" title="Property Index"><span class="none"></span>Property Index</a></li>
      <li><a href="../../query/hybrid-index.html" title="Hybrid Index"><span class="none"></span>Hybrid Index</a></li>
      <li><a href="../../query/solr.html" title="Solr Index"><span class="none"></span>Solr Index</a></li>
     </ul></li>
    <li><a href="../../security/overview.html" title="Security"><span class="icon-chevron-down"></span>Security</a>
     <ul class="nav nav-list">
      <li><a href="../../security/introduction.html" title="Introduction"><span class="none"></span>Introduction</a></li>
      <li><a href="../../security/reports.html" title="Reports"><span class="none"></span>Reports</a></li>
      <li><a href="../../security/authentication.html" title="Authentication"><span class="icon-chevron-right"></span>Authentication</a></li>
      <li><a href="../../security/authorization.html" title="Authorization"><span class="icon-chevron-right"></span>Authorization</a></li>
      <li><a href="../../security/principal.html" title="Principal Management"><span class="icon-chevron-right"></span>Principal Management</a></li>
      <li><a href="../../security/user.html" title="User Management"><span class="icon-chevron-right"></span>User Management</a></li>
     </ul></li>
    <li><a href="../../features/atomic-counter.html" title="Atomic Counter"><span class="none"></span>Atomic Counter</a></li>
    <li><a href="../../features/observation.html" title="Observation"><span class="none"></span>Observation</a></li>
   <li class="nav-header">Using Oak</li>
    <li><a href="../../use_getting_started.html" title="Getting Started"><span class="none"></span>Getting Started</a></li>
    <li><a href="../../construct.html" title="Repository Construction"><span class="none"></span>Repository Construction</a></li>
    <li><a href="../../osgi_config.html" title="Configuring Oak"><span class="none"></span>Configuring Oak</a></li>
    <li><a href="../../command_line.html" title="Command Line Tools"><span class="none"></span>Command Line Tools</a></li>
    <li><a href="../../migration.html" title="Migration"><span class="none"></span>Migration</a></li>
    <li><a href="../../differences.html" title="Differences to Jackrabbit 2"><span class="none"></span>Differences to Jackrabbit 2</a></li>
    <li><a href="../../known_issues.html" title="Known Issues"><span class="none"></span>Known Issues</a></li>
    <li><a href="../../constraints.html" title="Constraints"><span class="none"></span>Constraints</a></li>
    <li><a href="../../dos_and_donts.html" title="Dos and Don'ts"><span class="none"></span>Dos and Don'ts</a></li>
    <li><a href="../../coldstandby/coldstandby.html" title="Cold Standby"><span class="none"></span>Cold Standby</a></li>
    <li><a href="../../FAQ.html" title="FAQ"><span class="none"></span>FAQ</a></li>
   <li class="nav-header">Developing Oak</li>
    <li><a href="../../dev_getting_started.html" title="Getting Started"><span class="none"></span>Getting Started</a></li>
    <li><a href="../../participating.html" title="Participating"><span class="none"></span>Participating</a></li>
    <li><a href="../../testing.html" title="Testing"><span class="none"></span>Testing</a></li>
    <li><a href="../../oakathons.html" title="Oakathons"><span class="none"></span>Oakathons</a></li>
    <li><a href="../../developing-with-git.html" title="Developing with Git"><span class="none"></span>Developing with Git</a></li>
    <li><a href="../../diagnostic-builds.html" title="Cutting diagnostic builds"><span class="none"></span>Cutting diagnostic builds</a></li>
    <li><a href="../../branching.html" title="Branching off a new stable"><span class="none"></span>Branching off a new stable</a></li>
    <li><a href="../../attribution.html" title="Attribution"><span class="none"></span>Attribution</a></li>
    <li><a href="../../release-schedule.html" title="Release Schedule"><span class="none"></span>Release Schedule</a></li>
   <li class="nav-header">Links</li>
    <li><a href="http://jackrabbit.apache.org/oak" class="externalLink" title="Apache Jackrabbit Oak"><span class="none"></span>Apache Jackrabbit Oak</a></li>
    <li><a href="http://jackrabbit.apache.org/" class="externalLink" title="Apache Jackrabbit"><span class="none"></span>Apache Jackrabbit</a></li>
  </ul>
          </nav>
          <div class="well sidebar-nav">
<form id="search-form" action="https://www.google.com/search" method="get" >
  <input value="jackrabbit.apache.org/oak/docs/" name="sitesearch" type="hidden"/>
  <input class="search-query" name="q" id="query" type="text" placeholder="Search with Google..." />
</form>
            <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../../images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </header>
        <main id="bodyColumn"  class="span10" >
<!--
   Licensed to the Apache Software Foundation (ASF) under one or more
   contributor license agreements.  See the NOTICE file distributed with
   this work for additional information regarding copyright ownership.
   The ASF licenses this file to You under the Apache License, Version 2.0
   (the "License"); you may not use this file except in compliance with
   the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
  -->
<h1>RDB DocumentStore</h1>
<p>The <code>RDBDocumentStore</code> is one of the backend implementations for the
<a href="../documentmk.html">DocumentNodeStore</a>. It uses relational databases to
persist nodes as documents, mainly emulating the native capabilities of
<a href="mongo-document-store.html">MongoDocumentStore</a>.</p>
<p>Note that the <a href="/oak/docs/apidocs/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStore.html">API docs for RDBDocumentStore</a>
contain more implementation details.</p><section>
<h2><a name="Supported_Databases"></a>Supported Databases</h2>
<p>The code was written to be as database-agnostic as possible. That said, there
are vendor-specific code paths. Adding support for a new database type
however should be relatively straighforward. Most of the database-specific
code resides in the <code>RDBDocumentStoreDB</code> class.</p>
<p>The following databases are supported in the sense that they are recognized
and have been tested with:</p>
<p>For testing purposes:</p>
<ul>

<li>Apache Derby</li>
<li>H2DB</li>
</ul>
<p>For production use:</p>
<ul>

<li>IBM DB2 (LUW)</li>
<li>Microsoft SQL Server</li>
<li>MySQL (MariaDB)</li>
<li>Oracle</li>
<li>PostgreSQL</li>
</ul>
<p>For supported databases, <code>RDBDocumentStoreDB</code> has knowledge about supported
versions (and likewise supported JDBC drivers). Watch out for log messages
during system startup which might warn about outdated versions (the system
will attempt to start anyway):</p>

<div class="source"><pre class="prettyprint"><code>12:20:20.864 ERROR [main] RDBDocumentStore.java:1014        Unsupported Apache Derby version: 9.14, expected at least 10.11
</code></pre></div></section><section>
<h2><a name="Initialization"></a><a name="initialization"></a> Initialization</h2>
<p>The recommended method to initialize a <code>DocumentNodeStore</code> with an
<code>RDBDocumentStore</code> is using an OSGi container and configure the
<code>DocumentNodeStoreService</code>. See corresponding <a href="../../osgi_config.html#document-node-store">Repository OSGi Configuration</a>.</p>
<p>This will also require deploying the <a class="externalLink" href="https://sling.apache.org/documentation/bundles/datasource-providers.html">Sling DataSource provider</a>
and furthermore the associated JDBC driver as OSGi bundle. The details of the
latter vary by database:</p>
<ol style="list-style-type: decimal">

<li>If the JDBC driver already is an OSGI bundle, it can be deployed as is. This
is the case for Apache Derby, H2DB, IBM DB2, Microsoft SQL Server, MySQL,
and PostgreSQL. Some of these drivers also implement the <a class="externalLink" href="https://osgi.org/specification/osgi.cmpn/7.0.0/service.jdbc.html">OSGi Data Service Specification for JDBC</a> ,
in which case <code>org.osgi.service.jdbc-1.0.0.jar</code> needs to be deployed as well (this is the case for IBM DB2, Microsoft SQL Server, and PostgreSQL).</li>
<li>Otherwise (e.g., Oracle), an OSGi wrapper needs to be built. See <a href="#wrap-osgi">below</a>.</li>
</ol>
<p>Alternatively an RDB based DocumentNodeStore can be created with the help of
a <code>RDBDocumentNodeStoreBuilder</code>.</p>

<div class="source"><pre class="prettyprint"><code>DataSource dataSource = RDBDataSourceFactory.forJdbcUrl(jdbcurl, user, pw);
DocumentNodeStore store = RDBDocumentNodeStoreBuilder().newRDBDocumentNodeStoreBuilder()
    .setRDBConnection(dataSource).build();
// do something with the store
NodeState root = store.getRoot();

// dispose it when done
store.dispose();
</code></pre></div><section>
<h3><a name="Example:_Creating_OSGi_Bundle_for_Oracle_JDBC_driver"></a><a name="wrap-osgi"></a> Example: Creating OSGi Bundle for Oracle JDBC driver</h3>
<ol style="list-style-type: decimal">

<li>Make sure to have a local copy of the JDBC driver, for instance <code>ojdbc8-12.2.0.1.jar</code>.</li>
<li>Get BND command line tool from <a class="externalLink" href="https://repo1.maven.org/maven2/biz/aQute/bnd/biz.aQute.bnd/4.3.1/biz.aQute.bnd-4.3.1.jar">https://repo1.maven.org/maven2/biz/aQute/bnd/biz.aQute.bnd/4.3.1/biz.aQute.bnd-4.3.1.jar</a></li>
<li>Create BND <code>ora.bnd</code> below:</li>
</ol>

<div class="source"><pre class="prettyprint"><code> -classpath: ojdbc8-12.2.0.1.jar
 Bundle-SymbolicName: com.oracle.jdbc.ojdbc8
 ver: 12.2.0.1
 -output: ${bsn}-${ver}.jar
 Bundle-Version: ${ver}
 Include-Resource: @ojdbc8-12.2.0.1.jar
 Import-Package: *;resolution:=optional
</code></pre></div>
<p>Then run <code>java -jar biz.aQute.bnd-4.3.1.jar ora.bnd</code>; this should create the OSGi bundle <code>com.oracle.jdbc.ojdbc8-12.2.0.1.jar</code>.</p></section></section><section>
<h2><a name="Database_Creation"></a><a name="database-creation"></a> Database Creation</h2>
<p><code>RDBDocumentStore</code> relies on JDBC, and thus, in general, can not create
database instances (that said, certain DBs such as Apache Derby or H2DB can create the
database automatically when it's not there yet - consult the DB documentation
in general and the JDBC URL syntax specifically).</p>
<p>So in general, the administrator will have to take care of creating the database.
There are only a few requirements for the database, but these are critical for
the correct operation:</p>
<ul>

<li>character fields must be able to store any Unicode code point - UTF-8 encoding is recommended</li>
<li>the collation for character fields needs to sort by Unicode code points</li>
<li>BLOBs need to support sizes of ~16MB</li>
</ul>
<p>The subsections below give examples that have been found to work during the
development of <code>RDBDocumentStore</code>.</p><section>
<h3><a name="DB2"></a><a name="database-creation-db2"></a> DB2</h3>
<p>Creating a database called <code>OAK</code>:</p>

<div class="source"><pre class="prettyprint"><code>create database oak USING CODESET UTF-8 TERRITORY DEFAULT COLLATE USING IDENTITY;
</code></pre></div>
<p>To verify, check the INFO level log message written by <code>RDBDocumentStore</code>
upon startup. For example:</p>

<div class="source"><pre class="prettyprint"><code>14:47:20.332 INFO  [main] RDBDocumentStore.java:1065        RDBDocumentStore (SNAPSHOT) instantiated for database DB2/NT64 SQL11014 (11.1), using driver: IBM Data Server Driver for JDBC and SQLJ 4.19.77 (4.19), connecting to: jdbc:db2://localhost:50276/OAK, properties: {DB2ADMIN.CODEPAGE=1208, DB2ADMIN.COLLATIONSCHEMA=SYSIBM, DB2ADMIN.COLLATIONNAME=IDENTITY}, transaction isolation level: TRANSACTION_READ_COMMITTED (2), DB2ADMIN.NODES: ID VARCHAR(512), MODIFIED BIGINT, HASBINARY SMALLINT, DELETEDONCE SMALLINT, MODCOUNT BIGINT, CMODCOUNT BIGINT, DSIZE BIGINT, VERSION SMALLINT, SDTYPE SMALLINT, SDMAXREVTIME BIGINT, DATA VARCHAR(16384), BDATA BLOB(1073741824) /* {BIGINT=-5, BLOB=2004, SMALLINT=5, VARCHAR=12} */ /* index DB2ADMIN.NODES_MOD on DB2ADMIN.NODES (MODIFIED ASC) other (#0, p0), unique index DB2ADMIN.NODES_PK on DB2ADMIN.NODES (ID ASC) clustered (#0, p0), index DB2ADMIN.NODES_SDM on DB2ADMIN.NODES (SDMAXREVTIME ASC) other (#0, p0), index DB2ADMIN.NODES_SDT on DB2ADMIN.NODES (SDTYPE ASC) other (#0, p0), index DB2ADMIN.NODES_VSN on DB2ADMIN.NODES (VERSION ASC) other (#0, p0) */
</code></pre></div></section><section>
<h3><a name="MySQL"></a><a name="database-creation-mysql"></a> MySQL</h3>
<p>Creating a database called <code>OAK</code>:</p>

<div class="source"><pre class="prettyprint"><code>create database oak DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
</code></pre></div>
<p>Also make sure to configure the <code>max_allowed_packet</code> parameter
for the server (mysqld) to a value greater than 4M (such as 8388608).</p>
<p>To verify, check the INFO level log message written by <code>RDBDocumentStore</code>
upon startup. For example:</p>

<div class="source"><pre class="prettyprint"><code>13:40:46.637 INFO  [main] RDBDocumentStore.java:1065        RDBDocumentStore (SNAPSHOT) instantiated for database MySQL 8.0.15 (8.0), using driver: MySQL Connector/J mysql-connector-java-8.0.15 (Revision: 79a4336f140499bd22dd07f02b708e163844e3d5) (8.0), connecting to: jdbc:mysql://localhost:3306/oak?serverTimezone=UTC, properties: {character_set_database=utf8mb4, character_set_client=utf8mb4, character_set_connection=utf8mb4, character_set_results=, max_allowed_packet=8388608, collation_database=utf8mb4_unicode_ci, character_set_system=utf8, collation_server=utf8mb4_0900_ai_ci, collation=utf8mb4_unicode_ci, character_set_filesystem=binary, character_set_server=utf8mb4, collation_connection=utf8mb4_0900_ai_ci}, transaction isolation level: TRANSACTION_REPEATABLE_READ (4), .nodes: ID VARBINARY(512), MODIFIED BIGINT(20), HASBINARY SMALLINT(6), DELETEDONCE SMALLINT(6), MODCOUNT BIGINT(20), CMODCOUNT BIGINT(20), DSIZE BIGINT(20), VERSION SMALLINT(6), SDTYPE SMALLINT(6), SDMAXREVTIME BIGINT(20), DATA VARCHAR(16000), BDATA LONGBLOB(2147483647) /* {BIGINT=-5, LONGBLOB=-4, SMALLINT=5, VARBINARY=-3, VARCHAR=12} */ /* unique index oak.PRIMARY on nodes (ID ASC) other (#0, p0), index oak.NODES_MOD on nodes (MODIFIED ASC) other (#0, p0), index oak.NODES_SDM on nodes (SDMAXREVTIME ASC) other (#0, p0), index oak.NODES_SDT on nodes (SDTYPE ASC) other (#0, p0), index oak.NODES_VSN on nodes (VERSION ASC) other (#0, p0) */
</code></pre></div></section><section>
<h3><a name="Oracle"></a><a name="database-creation-oracle"></a> Oracle</h3>
<p>Creating a database called <code>OAK</code>:</p>
<p>&#x2026;is different compared to other databases. See <a class="externalLink" href="https://docs.oracle.com/cd/B28359_01/server.111/b28310/create003.htm">https://docs.oracle.com/cd/B28359_01/server.111/b28310/create003.htm</a> for more information. Defaults should work.</p>
<p>To verify, check the INFO level log message written by <code>RDBDocumentStore</code>
upon startup. For example:</p>

<div class="source"><pre class="prettyprint"><code>13:26:37.073 INFO  [main] RDBDocumentStore.java:1067        RDBDocumentStore (SNAPSHOT) instantiated for database Oracle Oracle Database 12c Enterprise Edition Release 12.2.0.1.0 - 64bit Production (12.2), using driver: Oracle JDBC driver 12.2.0.1.0 (12.2), connecting to: jdbc:oracle:thin:@localhost:1521:orcl, properties: {NLS_CHARACTERSET=AL32UTF8, NLS_COMP=BINARY}, transaction isolation level: TRANSACTION_READ_COMMITTED (2), .: ID VARCHAR2(512), MODIFIED NUMBER, HASBINARY NUMBER, DELETEDONCE NUMBER, MODCOUNT NUMBER, CMODCOUNT NUMBER, DSIZE NUMBER, VERSION NUMBER, SDTYPE NUMBER, SDMAXREVTIME NUMBER, DATA VARCHAR2(4000), BDATA BLOB(-1) /* {BLOB=2004, NUMBER=2, VARCHAR2=12} */ /* index NODES_MOD on SYSTEM.NODES (MODIFIED) clustered (#0, p0), index NODES_SDM on SYSTEM.NODES (SDMAXREVTIME) clustered (#0, p0), index NODES_SDT on SYSTEM.NODES (SDTYPE) clustered (#0, p0), index NODES_VSN on SYSTEM.NODES (VERSION) clustered (#0, p0), unique index SYS_C008093 on SYSTEM.NODES (ID) clustered (#0, p0) */
</code></pre></div></section><section>
<h3><a name="PostgreSQL"></a><a name="database-creation-postgresql"></a> PostgreSQL</h3>
<p>Creating a database called <code>OAK</code>:</p>

<div class="source"><pre class="prettyprint"><code>CREATE DATABASE &quot;oak&quot; TEMPLATE = template0 ENCODING = 'UTF8' LC_COLLATE = 'C' LC_CTYPE = 'C';
</code></pre></div>
<p>To verify, check the INFO level log message written by <code>RDBDocumentStore</code>
upon startup. For example:</p>

<div class="source"><pre class="prettyprint"><code>16:26:28.172 INFO  [main] RDBDocumentStore.java:1065        RDBDocumentStore (SNAPSHOT) instantiated for database PostgreSQL 10.6 (10.6), using driver: PostgreSQL JDBC Driver 42.2.5 (42.2), connecting to: jdbc:postgresql:oak, properties: {datcollate=C, pg_encoding_to_char(encoding)=UTF8}, transaction isolation level: TRANSACTION_READ_COMMITTED (2), .nodes: id varchar(512), modified int8, hasbinary int2, deletedonce int2, modcount int8, cmodcount int8, dsize int8, version int2, sdtype int2, sdmaxrevtime int8, data varchar(16384), bdata bytea(2147483647) /* {bytea=-2, int2=5, int8=-5, varchar=12} */ /* index nodes_mod on public.nodes (modified ASC) other (#0, p1), unique index nodes_pkey on public.nodes (id ASC) other (#0, p1), index nodes_sdm on public.nodes (sdmaxrevtime ASC) other (#0, p1), index nodes_sdt on public.nodes (sdtype ASC) other (#0, p1), index nodes_vsn on public.nodes (version ASC) other (#0, p1) */
</code></pre></div></section><section>
<h3><a name="SQL_Server"></a><a name="database-creation-sqlserver"></a> SQL Server</h3>
<p>Creating a database called <code>OAK</code>:</p>

<div class="source"><pre class="prettyprint"><code>create database OAK;
</code></pre></div>
<p>To verify, check the INFO level log message written by <code>RDBDocumentStore</code>
upon startup. For example:</p>

<div class="source"><pre class="prettyprint"><code>16:59:12.726 INFO  [main] RDBDocumentStore.java:1067        RDBDocumentStore (SNAPSHOT) instantiated for database Microsoft SQL Server 13.00.5081 (13.0), using driver: Microsoft JDBC Driver 7.2 for SQL Server 7.2.1.0 (7.2), connecting to: jdbc:sqlserver://localhost:1433;useBulkCopyForBatchInsert=false;cancelQueryTimeout=-1;sslProtocol=TLS;jaasConfigurationName=SQLJDBCDriver;statementPoolingCacheSize=0;serverPreparedStatementDiscardThreshold=10;enablePrepareOnFirstPreparedStatementCall=false;fips=false;socketTimeout=0;authentication=NotSpecified;authenticationScheme=nativeAuthentication;xopenStates=false;sendTimeAsDatetime=true;trustStoreType=JKS;trustServerCertificate=false;TransparentNetworkIPResolution=true;serverNameAsACE=false;sendStringParametersAsUnicode=true;selectMethod=direct;responseBuffering=adaptive;queryTimeout=-1;packetSize=8000;multiSubnetFailover=false;loginTimeout=15;lockTimeout=-1;lastUpdateCount=true;encrypt=false;disableStatementPooling=true;databaseName=OAK;columnEncryptionSetting=Disabled;applicationName=Microsoft JDBC Driver for SQL Server;applicationIntent=readwrite;, properties: {collation_name=Latin1_General_CI_AS}, transaction isolation level: TRANSACTION_READ_COMMITTED (2), .: ID varbinary(512), MODIFIED bigint, HASBINARY smallint, DELETEDONCE smallint, MODCOUNT bigint, CMODCOUNT bigint, DSIZE bigint, VERSION smallint, SDTYPE smallint, SDMAXREVTIME bigint, DATA nvarchar(4000), BDATA varbinary(2147483647) /* {bigint=-5, nvarchar=-9, smallint=5, varbinary=-3} */ /* index NODES.NODES_MOD on dbo.NODES (MODIFIED ASC) other (#0, p0), unique index NODES.NODES_PK on dbo.NODES (ID ASC) clustered (#0, p0), index NODES.NODES_SDM on dbo.NODES (SDMAXREVTIME ASC) other (#0, p0), index NODES.NODES_SDT on dbo.NODES (SDTYPE ASC) other (#0, p0), index NODES.NODES_VSN on dbo.NODES (VERSION ASC) other (#0, p0) */
</code></pre></div></section></section><section>
<h2><a name="Table_Creation"></a><a name="table-creation"></a> Table Creation</h2>
<p>The implementation will try to create all tables and indices when they are not present
yet. Of course this requires that the configured database user actually has
permission to do so. Example from system log:</p>

<div class="source"><pre class="prettyprint"><code>12:20:22.705 INFO  [main] RDBDocumentStore.java:1063        RDBDocumentStore (SNAPSHOT) instantiated for database Apache Derby 10.14.2.0 - (1828579) (10.14), using driver: Apache Derby Embedded JDBC Driver 10.14.2.0 - (1828579) (10.14), connecting to: jdbc:derby:./target/derby-ds-test, transaction isolation level: TRANSACTION_READ_COMMITTED (2), SA.NODES: ID VARCHAR(512), MODIFIED BIGINT, HASBINARY SMALLINT, DELETEDONCE SMALLINT, MODCOUNT BIGINT, CMODCOUNT BIGINT, DSIZE BIGINT, VERSION SMALLINT, SDTYPE SMALLINT, SDMAXREVTIME BIGINT, DATA VARCHAR(16384), BDATA BLOB(1073741824) /* {BIGINT=-5, BLOB=2004, SMALLINT=5, VARCHAR=12} */ /* index NODES_MOD on SA.NODES (MODIFIED ASC) other (#0, p0), index NODES_SDM on SA.NODES (SDMAXREVTIME ASC) other (#0, p0), index NODES_SDT on SA.NODES (SDTYPE ASC) other (#0, p0), index NODES_VSN on SA.NODES (VERSION ASC) other (#0, p0), unique index SQL190131122022490 on SA.NODES (ID ASC) other (#0, p0) */
12:20:22.705 INFO  [main] RDBDocumentStore.java:1070        Tables created upon startup: [CLUSTERNODES, NODES, SETTINGS, JOURNAL]
</code></pre></div>
<p>If it does not, the system will not start up and provide
diagnostics in the log file.</p>
<p>Administrators who want to create tables upfront can do so. The DDL statements
for the supported databases can be dumped using <a href="/oak/docs/apidocs/org/apache/jackrabbit/oak/plugins/document/rdb/RDBHelper.html">RDBHelper</a>
or, more recently, using <code>oak-run rdbddldump</code> (see <a href="#rdbddldump">below</a>).</p></section><section>
<h2><a name="Upgrade_from_earlier_versions"></a><a name="upgrade"></a> Upgrade from earlier versions</h2>
<p>As of Oak 1.8, the database layout has been slightly extended (see
<a href="/oak/docs/apidocs/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStore.html#apidocs.versioning">API docs for RDBDocumentStore</a>
for details).</p>
<p>Upon startup on an &#x201c;old&#x201d; database instance, <code>RDBDocumentStore</code> will try to
upgrade the tables. Example (for <code>NODES</code>):</p>

<div class="source"><pre class="prettyprint"><code>12:05:54.146 INFO  [main] RDBDocumentStore.java:1369        Upgraded NODES to DB level 1 using 'alter table NODES add VERSION smallint'

12:05:54.166 INFO  [main] RDBDocumentStore.java:1369        Upgraded NODES to DB level 2 using 'alter table NODES add SDMAXREVTIME bigint'
12:05:54.167 INFO  [main] RDBDocumentStore.java:1369        Upgraded NODES to DB level 2 using 'create index NODES_VSN on NODES (VERSION)'
12:05:54.167 INFO  [main] RDBDocumentStore.java:1369        Upgraded NODES to DB level 2 using 'create index NODES_SDT on NODES (SDTYPE)'
12:05:54.167 INFO  [main] RDBDocumentStore.java:1369        Upgraded NODES to DB level 2 using 'create index NODES_SDM on NODES (SDMAXREVTIME)'
</code></pre></div>
<p>If this fails, it will continue using the &#x201c;old&#x201d; layout,
and log diagnostics about the failed upgrade:</p>

<div class="source"><pre class="prettyprint"><code>12:05:56.746 INFO  [main] RDBDocumentStore.java:1379        Attempted to upgrade NODES to DB level 1 using 'alter table NODES add VERSION smallint', but failed with SQLException 'table alter statement rejected: alter table NODES add VERSION smallint' (code: 17/state: ABCDE) - will continue without.

12:05:56.955 INFO  [main] RDBDocumentStore.java:1379        Attempted to upgrade NODES to DB level 2 using 'alter table NODES add SDTYPE smallint', but failed with SQLException 'table alter statement rejected: alter table NODES add SDTYPE smallint' (code: 17/state: ABCDE) - will continue without.
12:05:56.955 INFO  [main] RDBDocumentStore.java:1379        Attempted to upgrade NODES to DB level 2 using 'alter table NODES add SDMAXREVTIME bigint', but failed with SQLException 'table alter statement rejected: alter table NODES add SDMAXREVTIME bigint' (code: 17/state: ABCDE) - will continue without.
12:05:56.964 INFO  [main] RDBDocumentStore.java:1379        Attempted to upgrade NODES to DB level 2 using 'create index NODES_SDT on NODES (SDTYPE)', but failed with SQLException ''SDTYPE' is not a column in table or VTI 'NODES'.' (code: 20000/state: 42X14) - will continue without.
12:05:56.964 INFO  [main] RDBDocumentStore.java:1379        Attempted to upgrade NODES to DB level 2 using 'create index NODES_SDM on NODES (SDMAXREVTIME)', but failed with SQLException ''SDMAXREVTIME' is not a column in table or VTI 'NODES'.' (code: 20000/state: 42X14) - will continue without.
</code></pre></div>
<p>The upgrade can then be done
at a later point of time by executing the required DDL statements.</p></section><section>
<h2><a name="oak-run_rdbddldump"></a><a name="rdbddldump"></a> oak-run rdbddldump</h2>
<p><code>@since Oak 1.8.12</code> <code>@since Oak 1.10.1</code> <code>@since Oak 1.12</code></p>
<p>The <code>rdbddldump</code> prints out the DDL statements that Oak would use to create or
update a database. It can be used to create the tables upfront, or to obtain
the DDL statements needed to upgrade to a newer schema version.</p>
<p>By default, it will print out the DDL statements for all supported databases,
with a target of the latest schema version.</p>
<p>The <code>--db</code> switch can be used to specify the database type (note that precise
spelling is needed, otherwise the code will fall back to a generic database
type).</p>
<p>The <code>--initial</code> switch selects the initial database schema (and defaults to
the most recent one).</p>
<p>The <code>--upgrade</code> switch selects the target database schema (and defaults to
the most recent one).</p>
<p>Selecting a higher &#x201c;upgrade&#x201d; version then the &#x201c;initial&#x201d; version causes the
tool to create separate DDL statements for the initial table schema (which may
already be there), and then to add individual statements for the upgrade to
the target schema.</p>
<p>For instance:</p>

<div class="source"><pre class="prettyprint"><code>java -jar oak-run-*.jar rdbddldump --db DB2 --initial 0 --upgrade 2
</code></pre></div>
<p>will dump statements for DB2, initially creating schema version 0 tables,
and then include DDL statements to upgrade to version 2 (the latter would
be applicable if an installation needed to be upgraded from an Oak version
older than 1.8 to 1.8 or newer).</p>

<div class="source"><pre class="prettyprint"><code>-- DB2

  -- creating table CLUSTERNODES for schema version 0
  create table CLUSTERNODES (ID varchar(512) not null, MODIFIED bigint, HASBINARY smallint, DELETEDONCE smallint, MODCOUNT bigint, CMODCOUNT bigint, DSIZE bigint, DATA varchar(16384), BDATA blob(1073741824))
  create unique index CLUSTERNODES_pk on CLUSTERNODES ( ID ) cluster
  alter table CLUSTERNODES add constraint CLUSTERNODES_pk primary key ( ID )
  create index CLUSTERNODES_MOD on CLUSTERNODES (MODIFIED)
  -- upgrading table CLUSTERNODES to schema version 1
  alter table CLUSTERNODES add VERSION smallint
  -- upgrading table CLUSTERNODES to schema version 2
  alter table CLUSTERNODES add SDTYPE smallint
  alter table CLUSTERNODES add SDMAXREVTIME bigint
  create index CLUSTERNODES_VSN on CLUSTERNODES (VERSION)
  create index CLUSTERNODES_SDT on CLUSTERNODES (SDTYPE) exclude null keys
  create index CLUSTERNODES_SDM on CLUSTERNODES (SDMAXREVTIME) exclude null keys

  -- creating table JOURNAL for schema version 0
  create table JOURNAL (ID varchar(512) not null, MODIFIED bigint, HASBINARY smallint, DELETEDONCE smallint, MODCOUNT bigint, CMODCOUNT bigint, DSIZE bigint, DATA varchar(16384), BDATA blob(1073741824))
  create unique index JOURNAL_pk on JOURNAL ( ID ) cluster
  alter table JOURNAL add constraint JOURNAL_pk primary key ( ID )
  create index JOURNAL_MOD on JOURNAL (MODIFIED)
  -- upgrading table JOURNAL to schema version 1
  alter table JOURNAL add VERSION smallint
  -- upgrading table JOURNAL to schema version 2
  alter table JOURNAL add SDTYPE smallint
  alter table JOURNAL add SDMAXREVTIME bigint
  create index JOURNAL_VSN on JOURNAL (VERSION)
  create index JOURNAL_SDT on JOURNAL (SDTYPE) exclude null keys
  create index JOURNAL_SDM on JOURNAL (SDMAXREVTIME) exclude null keys

  -- creating table NODES for schema version 0
  create table NODES (ID varchar(512) not null, MODIFIED bigint, HASBINARY smallint, DELETEDONCE smallint, MODCOUNT bigint, CMODCOUNT bigint, DSIZE bigint, DATA varchar(16384), BDATA blob(1073741824))
  create unique index NODES_pk on NODES ( ID ) cluster
  alter table NODES add constraint NODES_pk primary key ( ID )
  create index NODES_MOD on NODES (MODIFIED)
  -- upgrading table NODES to schema version 1
  alter table NODES add VERSION smallint
  -- upgrading table NODES to schema version 2
  alter table NODES add SDTYPE smallint
  alter table NODES add SDMAXREVTIME bigint
  create index NODES_VSN on NODES (VERSION)
  create index NODES_SDT on NODES (SDTYPE) exclude null keys
  create index NODES_SDM on NODES (SDMAXREVTIME) exclude null keys

  -- creating table SETTINGS for schema version 0
  create table SETTINGS (ID varchar(512) not null, MODIFIED bigint, HASBINARY smallint, DELETEDONCE smallint, MODCOUNT bigint, CMODCOUNT bigint, DSIZE bigint, DATA varchar(16384), BDATA blob(1073741824))
  create unique index SETTINGS_pk on SETTINGS ( ID ) cluster
  alter table SETTINGS add constraint SETTINGS_pk primary key ( ID )
  create index SETTINGS_MOD on SETTINGS (MODIFIED)
  -- upgrading table SETTINGS to schema version 1
  alter table SETTINGS add VERSION smallint
  -- upgrading table SETTINGS to schema version 2
  alter table SETTINGS add SDTYPE smallint
  alter table SETTINGS add SDMAXREVTIME bigint
  create index SETTINGS_VSN on SETTINGS (VERSION)
  create index SETTINGS_SDT on SETTINGS (SDTYPE) exclude null keys
  create index SETTINGS_SDM on SETTINGS (SDMAXREVTIME) exclude null keys

   -- creating blob store tables
  create table DATASTORE_META (ID varchar(64) not null primary key, LVL int, LASTMOD bigint)
  create table DATASTORE_DATA (ID varchar(64) not null primary key, DATA blob(2097152))
</code></pre></div></section><section>
<h2><a name="Using_oak-run"></a><a name="oak-run"></a> Using oak-run</h2>
<p>The <code>oak-run</code> JAR file does not include the JDBC driver needed to access the
database. Thus, a small amount of classpath surgery is needed.</p>
<p>Assuming the following two JAR files are in the current directory:</p>
<ul>

<li>oak-run-1.14.0.jar</li>
<li>db2-4.19.77.jar</li>
</ul>
<p>&#x2026;the invocation would be:</p>

<div class="source"><pre class="prettyprint"><code>$ java -cp &quot;oak-run-1.14.0.jar:db2-4.19.77.jar&quot; org.apache.jackrabbit.oak.run.Main
</code></pre></div>
<p>(where the path separator under Windows would be &#x201c;;&#x201d;).</p>
<p>In general, all commands applicable to a <code>MongoDocumentStore</code> should be available
for <code>RDBDocumentStore</code> as well. Simply substitute the &#x201c;mongdb:&#x2026;&#x201d; identifier
by the JDBC &#x201c;URL&#x201d;, and also specify DB credentials using <code>--rdbjdbcuser</code> and
<code>--rdbjdbcpasswd</code>.</p>
<p>Like that:</p>

<div class="source"><pre class="prettyprint"><code>$ java -cp &quot;oak-run-1.14.0.jar:db2-4.19.77.jar&quot; org.apache.jackrabbit.oak.run.Main clusternodes jdbc:db2://localhost:50276/OAK --rdbjdbcuser user --rdbjdbcpasswd passwd --verbose

Apache Jackrabbit Oak 1.14.0
Id    State          Started LeaseEnd Left RecoveryBy      LastRootRev    OakVersion
 1 INACTIVE 20190125T110237Z        -    -          - r16884ad047c-0-1 1.12-SNAPSHOT
</code></pre></div>
<p>Note that in Oak versions prior to June 2019, <code>oak-run</code> also does not contain
the artefacts <code>tomcat-jdbc</code> and <code>tomcat-juli</code>, which thus need to be added to
the classpath as well (see OAK-8341 for details).</p></section><section>
<h2><a name="Reading_Log_Files"></a><a name="reading-log-files"></a> Reading Log Files</h2>
<p>There are certain log messages to look out for when investigating problems,
and also some that may cause unneeded confusion.</p>
<p>See below.</p><section>
<h3><a name="Startup_Message"></a><a name="startup-messages"></a> Startup Message</h3>
<p>Such as:</p>

<div class="source"><pre class="prettyprint"><code>16:26:28.172 INFO  [main] RDBDocumentStore.java:1065        RDBDocumentStore (SNAPSHOT) instantiated for database PostgreSQL 10.6 (10.6), using driver: PostgreSQL JDBC Driver 42.2.5 (42.2), connecting to: jdbc:postgresql:oak, properties: {datcollate=C, pg_encoding_to_char(encoding)=UTF8}, transaction isolation level: TRANSACTION_READ_COMMITTED (2), .nodes: id varchar(512), modified int8, hasbinary int2, deletedonce int2, modcount int8, cmodcount int8, dsize int8, version int2, sdtype int2, sdmaxrevtime int8, data varchar(16384), bdata bytea(2147483647) /* {bytea=-2, int2=5, int8=-5, varchar=12} */ /* index nodes_mod on public.nodes (modified ASC) other (#0, p1), unique index nodes_pkey on public.nodes (id ASC) other (#0, p1), index nodes_sdm on public.nodes (sdmaxrevtime ASC) other (#0, p1), index nodes_sdt on public.nodes (sdtype ASC) other (#0, p1), index nodes_vsn on public.nodes (version ASC) other (#0, p1) */
</code></pre></div>
<p>The information dumped here is essential for diagnosing issues and should be
included in all bug reports. It includes:</p>
<ul>

<li>Oak's version number</li>
<li>Database type and version</li>
<li>JDBC driver and version</li>
<li>JDBC &#x201c;URL&#x201d;</li>
<li>certain DB-specific properties</li>
<li>JDBC transaction isolation level</li>
<li>schema for &#x201c;NODES&#x201d; table (other tables are not reported; they ought to be the same)</li>
<li>information on database indices</li>
</ul></section><section>
<h3><a name="a.E2.80.9CLong_Running_Queries.E2.80.9D"></a><a name="long-running-queries"></a> &#x201c;Long Running Queries&#x201d;</h3>
<p>RDBDocumentStore will log an INFO message when a query takes longer than 10s,
which frequently indicates a configuration problem.</p>

<div class="source"><pre class="prettyprint"><code>INFO  ... org.apache.jackrabbit.oak.plugins.document.rdb.RDBDocumentStoreJDBC - Long running query on NODES with 100 hits (limited to 100), elapsed time 11361ms (configured QUERYTIMELIMIT 10000), params minid 'null' maxid 'null' excludeKeyPatterns [] conditions [_modified &gt;= 1554909530] limit 100. Result range: '0:/'...'12:/...'. Read 26126 chars from DATA and 0 bytes from BDATA. Check calling method.
java.lang.Exception: call stack
</code></pre></div>
<p>The call stack is dumped to identify the piece of code that executed the query.
It is important to understand that this is not an error, it is just logged
for diagnostic purposes.</p></section><section>
<h3><a name="Tomcat_JDBC_Pool_Interceptor_Messages"></a><a name="tomcat-jdbc-pool-interceptor"></a> Tomcat JDBC Pool Interceptor Messages</h3>
<p>When using the Tomcat JDBC connection pool, by default &#x201c;slow&#x201d; and &#x201c;failed&#x201d;
queries will be logged on WARN level. The latter category is a bit problematic,
as what Tomcat thinks is a failure might be completely normal and expected
behavior. For instance:</p>

<div class="source"><pre class="prettyprint"><code>WARN [...] org.apache.tomcat.jdbc.pool.interceptor.SlowQueryReport Failed Query Report SQL=update NODES set MODIFIED = case when ? &gt; MODIFIED then ? else MODIFIED end, HASBINARY = ?, DELETEDONCE = ?, MODCOUNT = ?, CMODCOUNT = ?, DSIZE = DSIZE + ?, VERSION = 2, DATA = CASE WHEN LEN(DATA) &lt; ? THEN (DATA + CAST(? AS nvarchar(4000))) ELSE (DATA + CAST(DATA AS nvarchar(max))) END where ID = ? and MODCOUNT = ?; time=1 ms;
</code></pre></div>
<p>This just indicates that an update operation that was made conditional did not
happen because the condition was not met.</p>
<p>Another example are insert operations, which are done &#x201c;optimistically&#x201d;, and will
automatically be retried as updates upon failure.</p></section></section>
        </main>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
<p>&#169; 2012-2024
<a href="https://www.apache.org/">The Apache Software Foundation</a> &vert; <a href="https://privacy.apache.org/policies/privacy-policy-public.html">Privacy Policy</a>
</p>
        </div>
      </div>
    </footer>
<script>
	if(anchors) {
	  anchors.add();
	}
</script>
  </body>
</html>